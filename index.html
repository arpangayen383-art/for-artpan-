<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARPAN AI Pro | Multimodal Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0ea5e9;
            --secondary: #6366f1;
            --accent: #f472b6;
            --bg: #020617;
            --glass: rgba(15, 23, 42, 0.75);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg);
            color: #f8fafc;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            pointer-events: none;
        }

        .glass-morphism {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .hover-trigger {
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .hover-trigger:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 0 25px rgba(14, 165, 233, 0.3);
        }

        .sidebar-item {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(14, 165, 233, 0.15) 0%, transparent 100%);
            color: var(--primary);
        }

        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
        }

        .chat-bubble {
            animation: slideIn 0.4s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glow-text {
            text-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* Audio Wave Animation */
        .audio-wave span {
            display: inline-block;
            width: 3px;
            height: 10px;
            background-color: var(--primary);
            animation: wave 1s infinite ease-in-out;
            margin: 0 1px;
            border-radius: 2px;
        }
        .audio-wave span:nth-child(2) { animation-delay: 0.1s; }
        .audio-wave span:nth-child(3) { animation-delay: 0.2s; }
        .audio-wave span:nth-child(4) { animation-delay: 0.3s; }
        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 20px; }
        }
    </style>
</head>
<body class="flex">

    <canvas id="three-canvas"></canvas>

    <!-- Navigation Rail -->
    <nav class="w-20 md:w-64 h-full glass-morphism border-r border-slate-800 z-10 flex flex-col transition-all duration-500">
        <div class="p-8 flex items-center space-x-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-sky-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-sky-500/20">
                <i class="fas fa-microchip text-white text-xl"></i>
            </div>
            <span class="text-xl font-extrabold tracking-tighter hidden md:block glow-text uppercase">ARPAN AI</span>
        </div>

        <div class="flex-1 px-4 py-6 space-y-4">
            <button onclick="switchModule('chat')" data-module="chat" class="sidebar-item active w-full p-4 rounded-2xl flex items-center space-x-4 group">
                <i class="fas fa-comment-dots text-lg group-hover:scale-110 transition-transform"></i>
                <span class="font-semibold hidden md:block">Neural Chat</span>
            </button>
            <button onclick="switchModule('visuals')" data-module="visuals" class="sidebar-item w-full p-4 rounded-2xl flex items-center space-x-4 group">
                <i class="fas fa-image text-lg group-hover:scale-110 transition-transform text-pink-400"></i>
                <span class="font-semibold hidden md:block">Visual Studio</span>
            </button>
            <button onclick="switchModule('tasks')" data-module="tasks" class="sidebar-item w-full p-4 rounded-2xl flex items-center space-x-4 group">
                <i class="fas fa-project-diagram text-lg group-hover:scale-110 transition-transform"></i>
                <span class="font-semibold hidden md:block">Logic Tasks</span>
            </button>
            <button onclick="switchModule('creative')" data-module="creative" class="sidebar-item w-full p-4 rounded-2xl flex items-center space-x-4 group">
                <i class="fas fa-wand-magic-sparkles text-lg group-hover:scale-110 transition-transform"></i>
                <span class="font-semibold hidden md:block">Creative Studio</span>
            </button>
            <button onclick="switchModule('analytics')" data-module="analytics" class="sidebar-item w-full p-4 rounded-2xl flex items-center space-x-4 group">
                <i class="fas fa-chart-pie text-lg group-hover:scale-110 transition-transform"></i>
                <span class="font-semibold hidden md:block">Analytics</span>
            </button>
        </div>

        <div class="p-6">
            <div class="glass-morphism p-4 rounded-2xl border-slate-700/50 hidden md:block">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Core Status</span>
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                </div>
                <p class="text-[11px] text-slate-400 uppercase">ARPAN V2.0 Online</p>
            </div>
        </div>
    </nav>

    <!-- Main Application Stage -->
    <main class="flex-1 flex flex-col z-10 relative overflow-hidden">
        
        <!-- Top Interface -->
        <header class="h-20 flex items-center justify-between px-10 border-b border-white/5">
            <div>
                <h2 id="view-title" class="text-2xl font-bold text-white">Neural Hub</h2>
                <p class="text-xs text-slate-500">ARPAN Processing Ready</p>
            </div>
            <div class="flex items-center space-x-6">
                <button id="tts-toggle" onclick="toggleTTS()" class="w-10 h-10 rounded-full glass-morphism flex items-center justify-center hover:bg-white/5 transition-colors border border-transparent">
                    <i class="fas fa-volume-up text-slate-400"></i>
                </button>
                <div class="flex -space-x-2">
                    <div class="w-8 h-8 rounded-full border-2 border-slate-900 bg-sky-500 flex items-center justify-center text-[10px] font-bold">AR</div>
                    <div class="w-8 h-8 rounded-full border-2 border-slate-900 bg-slate-800 flex items-center justify-center text-[10px] text-slate-400"><i class="fas fa-user"></i></div>
                </div>
            </div>
        </header>

        <!-- Viewport -->
        <div id="viewport" class="flex-1 overflow-y-auto p-6 md:p-10 custom-scroll">
            
            <!-- CHAT VIEW -->
            <div id="view-chat" class="view-content h-full flex flex-col max-w-5xl mx-auto">
                <div id="chat-history" class="flex-1 overflow-y-auto space-y-6 pb-20 custom-scroll">
                    <div class="chat-bubble flex items-start space-x-4">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-sky-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
                            <i class="fas fa-robot text-sm"></i>
                        </div>
                        <div class="glass-morphism p-5 rounded-2xl rounded-tl-none max-w-2xl border-l-4 border-l-sky-500">
                            <p class="text-sm leading-relaxed text-slate-200">System upgraded. I am <b>ARPAN v2</b>. I can now see images, generate visuals, and speak to you. Attach an image to begin visual analysis.</p>
                            <div class="mt-4 flex gap-2">
                                <button onclick="quickAction('Analyze this image')" class="text-[10px] bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-1 rounded-full transition-all">Analyze Image</button>
                                <button onclick="switchModule('visuals')" class="text-[10px] bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-1 rounded-full transition-all">Create Image</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="absolute bottom-10 left-1/2 -translate-x-1/2 w-full max-w-3xl px-6">
                    <!-- Image Preview Area -->
                    <div id="image-preview-container" class="hidden mb-2 relative inline-block">
                        <img id="image-preview" src="" class="h-20 w-auto rounded-lg border border-sky-500/50 shadow-lg shadow-sky-500/20">
                        <button onclick="clearImage()" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-[10px] text-white hover:bg-red-600"><i class="fas fa-times"></i></button>
                    </div>

                    <div class="glass-morphism p-2 rounded-3xl flex items-center border-white/10 shadow-2xl">
                        <button onclick="document.getElementById('image-upload').click()" class="w-10 h-10 rounded-full hover:bg-white/5 flex items-center justify-center text-slate-400 hover:text-sky-400 transition-colors">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="image-upload" class="hidden" accept="image/*" onchange="handleImageUpload(this)">
                        
                        <input type="text" id="chat-input" placeholder="Communicate with ARPAN..." class="flex-1 bg-transparent px-4 py-3 focus:outline-none text-sm text-slate-200">
                        
                        <button onclick="sendMessage()" class="w-12 h-12 rounded-2xl bg-sky-600 hover:bg-sky-500 transition-all flex items-center justify-center text-white shadow-lg shadow-sky-600/30">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VISUAL STUDIO (IMAGE GEN) VIEW -->
            <div id="view-visuals" class="view-content hidden">
                <div class="max-w-4xl mx-auto space-y-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-sky-400">Visual Synthesis Core</h2>
                        <p class="text-slate-500">Describe a scene. ARPAN will render it.</p>
                    </div>

                    <div class="glass-morphism p-2 rounded-2xl flex items-center border-white/10 shadow-2xl">
                        <input type="text" id="gen-input" placeholder="E.g., A futuristic cyberpunk city with neon rain..." class="flex-1 bg-transparent px-6 py-4 focus:outline-none text-sm text-slate-200">
                        <button onclick="generateImage()" class="px-6 py-3 rounded-xl bg-pink-600 hover:bg-pink-500 transition-all text-white text-sm font-bold shadow-lg shadow-pink-600/30 flex items-center gap-2">
                            <i class="fas fa-magic"></i> Generate
                        </button>
                    </div>

                    <div id="gen-result-container" class="glass-morphism min-h-[400px] rounded-3xl flex flex-col items-center justify-center border-dashed border-2 border-white/5 relative overflow-hidden group">
                        <div id="gen-placeholder" class="text-slate-600 text-center">
                            <i class="fas fa-image text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm">No visual data synthesized yet.</p>
                        </div>
                        <div id="gen-loading" class="hidden flex flex-col items-center">
                            <div class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                            <p class="text-xs text-pink-400 animate-pulse">Rendering pixels...</p>
                        </div>
                        <img id="generated-image" class="hidden w-full h-full object-contain rounded-2xl transition-transform duration-700 group-hover:scale-105" src="">
                    </div>
                </div>
            </div>

            <!-- TASKS VIEW -->
            <div id="view-tasks" class="view-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="glass-morphism p-8 rounded-3xl">
                            <h3 class="font-bold mb-4">Initialize Objective</h3>
                            <div class="flex gap-4">
                                <input type="text" id="task-input" placeholder="Describe the mission..." class="flex-1 bg-slate-900/50 border border-white/5 rounded-2xl px-6 py-3 focus:border-sky-500/50 transition-all text-slate-200">
                                <button onclick="addTask()" class="bg-white text-slate-900 px-8 rounded-2xl font-bold hover:bg-sky-400 transition-all">Create</button>
                            </div>
                        </div>
                        <div id="task-container" class="space-y-4"></div>
                    </div>
                    <div class="space-y-6">
                        <div class="glass-morphism p-6 rounded-3xl border-l-4 border-l-amber-500">
                            <h4 class="text-xs font-bold text-amber-500 uppercase tracking-widest mb-4">ARPAN Priority</h4>
                            <div id="priority-list" class="space-y-4 text-sm text-slate-400">
                                <p class="italic">Analyzing task hierarchy...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CREATIVE VIEW -->
            <div id="view-creative" class="view-content hidden">
                <div class="max-w-4xl mx-auto space-y-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold mb-2">Creative Synthesis</h2>
                        <p class="text-slate-500">ARPAN Engine: Transforming raw data into structured brilliance.</p>
                    </div>
                    <div class="glass-morphism p-8 rounded-3xl">
                        <textarea id="creative-input" rows="10" class="w-full bg-transparent border border-white/10 rounded-2xl p-6 focus:outline-none focus:border-sky-500/50 transition-all custom-scroll text-slate-200" placeholder="Paste content to summarize, refine, or restructure..."></textarea>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                            <button onclick="processCreative('summarize')" class="hover-trigger p-4 glass-morphism rounded-2xl text-center">
                                <i class="fas fa-compress-alt mb-2 text-sky-400"></i>
                                <span class="block text-xs font-bold">Summarize</span>
                            </button>
                            <button onclick="processCreative('refine')" class="hover-trigger p-4 glass-morphism rounded-2xl text-center">
                                <i class="fas fa-magic mb-2 text-indigo-400"></i>
                                <span class="block text-xs font-bold">Refine Tone</span>
                            </button>
                            <button onclick="processCreative('bullets')" class="hover-trigger p-4 glass-morphism rounded-2xl text-center">
                                <i class="fas fa-list-ul mb-2 text-amber-400"></i>
                                <span class="block text-xs font-bold">Key Points</span>
                            </button>
                            <button onclick="processCreative('expand')" class="hover-trigger p-4 glass-morphism rounded-2xl text-center">
                                <i class="fas fa-expand-arrows-alt mb-2 text-emerald-400"></i>
                                <span class="block text-xs font-bold">Deepen</span>
                            </button>
                        </div>
                    </div>
                    <div id="creative-output-box" class="hidden animate-fade-in glass-morphism p-8 rounded-3xl border-sky-500/20">
                        <div class="flex justify-between mb-4">
                            <span class="text-xs font-bold text-sky-400 uppercase">ARPAN Synthesis</span>
                            <button onclick="copyCreative()" class="hover:text-sky-400 transition-colors"><i class="fas fa-copy"></i></button>
                        </div>
                        <div id="creative-result" class="text-slate-300 leading-relaxed text-sm whitespace-pre-wrap"></div>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS VIEW -->
            <div id="view-analytics" class="view-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div class="glass-morphism p-8 rounded-3xl">
                        <p class="text-slate-500 text-xs font-bold uppercase">ARPAN Cycle Load</p>
                        <h4 class="text-4xl font-extrabold mt-2 text-sky-400" id="stat-queries">0</h4>
                        <div class="w-full h-1 bg-slate-800 mt-4 rounded-full overflow-hidden">
                            <div class="h-full bg-sky-500" style="width: 65%"></div>
                        </div>
                    </div>
                    <div class="glass-morphism p-8 rounded-3xl">
                        <p class="text-slate-500 text-xs font-bold uppercase">Efficiency Rate</p>
                        <h4 class="text-4xl font-extrabold mt-2 text-indigo-400">99.2%</h4>
                        <div class="w-full h-1 bg-slate-800 mt-4 rounded-full overflow-hidden">
                            <div class="h-full bg-indigo-500" style="width: 89%"></div>
                        </div>
                    </div>
                    <div class="glass-morphism p-8 rounded-3xl">
                        <p class="text-slate-500 text-xs font-bold uppercase">Success Index</p>
                        <h4 class="text-4xl font-extrabold mt-2 text-emerald-400" id="stat-tasks">0</h4>
                        <div class="w-full h-1 bg-slate-800 mt-4 rounded-full overflow-hidden">
                            <div class="h-full bg-emerald-500" style="width: 45%"></div>
                        </div>
                    </div>
                </div>
                <div class="glass-morphism p-10 rounded-3xl">
                    <h3 class="text-xl font-bold mb-6">ARPAN Insight Report</h3>
                    <div id="ai-insight" class="text-slate-400 italic">
                        Insufficient operational data for ARPAN to generate deep behavioral insights.
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- 3D BACKGROUND INITIALIZATION ---
        const canvas = document.getElementById('three-canvas');
        const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        let particles;
        const initThree = () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            const geometry = new THREE.BufferGeometry();
            const count = 1500;
            const positions = new Float32Array(count * 3);
            
            for(let i=0; i<count*3; i++) {
                positions[i] = (Math.random() - 0.5) * 10;
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const material = new THREE.PointsMaterial({
                size: 0.015,
                color: 0x0ea5e9,
                transparent: true,
                opacity: 0.5,
                blending: THREE.AdditiveBlending
            });
            
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
            camera.position.z = 3;
        };

        const animateThree = () => {
            requestAnimationFrame(animateThree);
            particles.rotation.y += 0.001;
            particles.rotation.x += 0.0005;
            renderer.render(scene, camera);
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- APP LOGIC ---
        const apiKey = "AIzaSyAb3nHp15gXiP6aISEwpB2TQ9DcBJ0_Ie4"; // Will be injected by system
        let state = {
            tasks: JSON.parse(localStorage.getItem('ar_tasks')) || [],
            stats: JSON.parse(localStorage.getItem('ar_stats')) || { queries: 0, done: 0 },
            isTTS: false,
            currentImage: null
        };

        // --- TTS & Audio Helpers ---
        // Basic WAV Header generator for PCM data
        function pcmToWav(pcmData, sampleRate = 24000) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmData.length * 2, true);

            const length = pcmData.length;
            for (let i = 0; i < length; i++) {
                // PCM16 is signed, but coming from base64 decode we might need care.
                // Assuming raw Int16 input or similar.
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        // Base64 to Int16 Array helper
        function base64ToInt16(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Int16Array(len / 2);
            for (let i = 0; i < len; i+=2) {
                // Combine two bytes into Int16 (Little Endian)
                bytes[i/2] = (binaryString.charCodeAt(i+1) << 8) | binaryString.charCodeAt(i);
            }
            return bytes;
        }

        async function speakText(text) {
            if (!state.isTTS) return;
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts[0].inlineData) {
                    const audioBase64 = data.candidates[0].content.parts[0].inlineData.data;
                    const pcmData = base64ToInt16(audioBase64);
                    const wavBlob = pcmToWav(pcmData, 24000);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                }
            } catch (e) {
                console.error("TTS Error", e);
            }
        }

        const toggleTTS = () => {
            state.isTTS = !state.isTTS;
            const btn = document.getElementById('tts-toggle');
            if(state.isTTS) {
                btn.classList.add('bg-sky-500', 'text-white', 'border-sky-400');
                btn.classList.remove('glass-morphism');
            } else {
                btn.classList.remove('bg-sky-500', 'text-white', 'border-sky-400');
                btn.classList.add('glass-morphism');
            }
        };


        const switchModule = (mod) => {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${mod}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.toggle('active', i.dataset.module === mod));
            document.getElementById('view-title').innerText = mod.charAt(0).toUpperCase() + mod.slice(1) + (mod === 'chat' ? ' Hub' : ' Core');
        };

        async function callAI(prompt, system = "", imageBase64 = null) {
            state.stats.queries++;
            save();
            try {
                const parts = [{ text: prompt }];
                if (imageBase64) {
                    parts.push({ inlineData: { mimeType: "image/png", data: imageBase64 } });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: parts }],
                        systemInstruction: { parts: [{ text: system || "You are ARPAN, a high-intelligence futuristic AI assistant. Your tone is conversational, friendly, and professional. Use markdown and be concise." }] }
                    })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Communication relay failed.";
                
                // Trigger TTS
                if(text) speakText(text);
                
                return text;
            } catch (e) {
                return "Quantum link interrupted. Check connection.";
            }
        }

        // --- IMAGE GEN (IMAGEN) ---
        async function generateImage() {
            const prompt = document.getElementById('gen-input').value;
            if(!prompt) return;

            const loader = document.getElementById('gen-loading');
            const placeholder = document.getElementById('gen-placeholder');
            const imgResult = document.getElementById('generated-image');

            placeholder.classList.add('hidden');
            imgResult.classList.add('hidden');
            loader.classList.remove('hidden');
            loader.classList.add('flex');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instances: [{ prompt: prompt }],
                        parameters: { sampleCount: 1 }
                    })
                });
                const data = await response.json();
                
                if (data.predictions && data.predictions[0] && data.predictions[0].bytesBase64Encoded) {
                    const imgUrl = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    imgResult.src = imgUrl;
                    imgResult.classList.remove('hidden');
                } else {
                    alert("Image generation failed or policy blocked.");
                    placeholder.classList.remove('hidden');
                }
            } catch (e) {
                alert("Generation error: " + e);
                placeholder.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }


        // --- CHAT SYSTEM ---
        const handleImageUpload = (input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Store base64 without prefix for API
                    state.currentImage = e.target.result.split(',')[1];
                    // Show preview
                    document.getElementById('image-preview').src = e.target.result;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        const clearImage = () => {
            state.currentImage = null;
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('image-upload').value = '';
        };

        const sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            const hasImage = !!state.currentImage;
            
            if(!val && !hasImage) return;

            // Add user bubble
            let displayHtml = val.replace(/\n/g, '<br>');
            if(hasImage) {
                displayHtml += `<br><span class="text-xs text-sky-400 italic">[Attached Image]</span>`;
            }
            addBubble('user', displayHtml);
            
            input.value = '';
            
            const imgData = state.currentImage;
            clearImage(); // Clear after sending

            // Loading bubble
            const loadingId = addBubble('ai', '<span class="animate-pulse">Analyzing...</span>');

            // Call API
            const response = await callAI(val || "What is in this image?", "", imgData);
            
            // Replace loading with response
            const history = document.getElementById('chat-history');
            history.lastElementChild.remove(); // Remove loading
            addBubble('ai', response);
        };

        const addBubble = (role, text) => {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-bubble flex items-start space-x-4 ${role === 'user' ? 'flex-row-reverse space-x-reverse' : ''}`;
            
            div.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr ${role === 'ai' ? 'from-sky-500 to-indigo-600' : 'from-slate-700 to-slate-800'} flex-shrink-0 flex items-center justify-center">
                    <i class="fas ${role === 'ai' ? 'fa-robot' : 'fa-user'} text-sm"></i>
                </div>
                <div class="glass-morphism p-5 rounded-2xl ${role === 'ai' ? 'rounded-tl-none border-l-4 border-l-sky-500' : 'rounded-tr-none border-r-4 border-r-indigo-500'} max-w-2xl">
                    <p class="text-sm leading-relaxed text-slate-200">${text}</p>
                    ${role === 'ai' && state.isTTS ? '<div class="audio-wave mt-2 h-4 flex items-end"><span></span><span></span><span></span><span></span></div>' : ''}
                </div>
            `;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div.id;
        };

        const quickAction = (cmd) => {
            document.getElementById('chat-input').value = cmd;
            sendMessage();
        };

        // --- TASK SYSTEM ---
        const addTask = () => {
            const input = document.getElementById('task-input');
            if(!input.value) return;
            state.tasks.unshift({ id: Date.now(), text: input.value, done: false });
            input.value = '';
            renderTasks();
            save();
        };

        const renderTasks = () => {
            const cont = document.getElementById('task-container');
            cont.innerHTML = state.tasks.map(t => `
                <div class="glass-morphism p-5 rounded-2xl flex items-center justify-between group animate-fade-in">
                    <div class="flex items-center space-x-4">
                        <div onclick="toggleTask(${t.id})" class="w-6 h-6 rounded-lg border-2 border-white/10 flex items-center justify-center cursor-pointer transition-all ${t.done ? 'bg-sky-500 border-sky-500' : 'hover:border-sky-500'}">
                            ${t.done ? '<i class="fas fa-check text-[10px]"></i>' : ''}
                        </div>
                        <span class="text-sm ${t.done ? 'line-through text-slate-500' : 'text-slate-200'}">${t.text}</span>
                    </div>
                    <button onclick="delTask(${t.id})" class="opacity-0 group-hover:opacity-100 transition-all text-slate-600 hover:text-red-400">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('') || '<div class="text-center py-10 text-slate-500 italic">No mission objectives identified.</div>';
            updateStats();
        };

        const toggleTask = (id) => {
            const t = state.tasks.find(x => x.id === id);
            t.done = !t.done;
            if(t.done) state.stats.done++;
            save();
            renderTasks();
        };

        const delTask = (id) => {
            state.tasks = state.tasks.filter(x => x.id !== id);
            save();
            renderTasks();
        };

        // --- CREATIVE SYSTEM ---
        async function processCreative(mode) {
            const input = document.getElementById('creative-input').value;
            const resBox = document.getElementById('creative-output-box');
            const resText = document.getElementById('creative-result');
            if(!input) return;

            resBox.classList.remove('hidden');
            resText.innerText = "ARPAN: Synthesizing data stream...";

            let prompt = "";
            if(mode === 'summarize') prompt = `Summarize this into 3 powerful sentences: ${input}`;
            if(mode === 'refine') prompt = `Rewrite this to be more professional and futuristic: ${input}`;
            if(mode === 'bullets') prompt = `Extract key technical bullet points: ${input}`;
            if(mode === 'expand') prompt = `Deepen the logic and detail of this content: ${input}`;

            const result = await callAI(prompt, "You are ARPAN, a senior creative strategist. Output high-impact text.");
            resText.innerText = result;
            updateStats();
        }

        // --- STATS ---
        function updateStats() {
            document.getElementById('stat-queries').innerText = state.stats.queries;
            document.getElementById('stat-tasks').innerText = state.stats.done;
            
            if(state.stats.done > 2) {
                document.getElementById('ai-insight').innerHTML = `
                    <div class="p-4 border border-sky-500/20 rounded-2xl bg-sky-500/5 text-sm text-sky-200">
                        <b>ARPAN Insight:</b> You are highly effective in current mission parameters. Peak efficiency reached.
                    </div>
                `;
            }
        }

        function save() {
            localStorage.setItem('ar_tasks', JSON.stringify(state.tasks));
            localStorage.setItem('ar_stats', JSON.stringify(state.stats));
        }

        window.onload = () => {
            initThree();
            animateThree();
            renderTasks();
            updateStats();
        };

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });
        document.getElementById('gen-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') generateImage();
        });
    </script>
</body>
</html>
